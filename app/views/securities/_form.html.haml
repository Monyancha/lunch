= form_for(@securities_release_request, validate: true, url: url, html: {class: 'securities-submit-release-form'}) do |f|
  = f.hidden_field(:request_id)
  = f.hidden_field(:trade_date)
  = f.hidden_field(:settlement_date)
  - if @errors
    .securities-submit-release-form-errors
      - @errors.values.uniq.each do |message|
        %p= message
  %section.securities-broker-instructions
    %h2= t('securities.release.broker_instructions')
    - if account_number
      .input-field-container-horizontal
        = render 'shared/input_field', form_builder: f, field_name: :account_number, label: t('securities.release.account_number.label'), field_class: ['disabled'], html_attributes: { disabled: true }
      .input-field-container-horizontal.pledge_type
        - if type == :pledge
          %label{for: 'pledge_type'}= t('securities.release.pledge_type.label')
          = render 'shared/dropdown', dropdown_name: 'securities_release_request[pledge_type]', default_value: @pledge_type_dropdown.first.last, default_text: @pledge_type_dropdown.first.first, dropdown_options: @pledge_type_dropdown
    .input-field-container-horizontal
      %label{for: 'release_transaction_code'}= t('securities.release.transaction_code.label')
      = render 'shared/dropdown', dropdown_name: 'securities_release_request[transaction_code]', default_value: @transaction_code_defaults[:value], default_text: @transaction_code_defaults[:text], dropdown_options: @transaction_code_dropdown
    .input-field-container-horizontal
      %label{for: 'release_settlement_type'}= t('securities.release.settlement_type.label')
      = render 'shared/dropdown', dropdown_name: 'securities_release_request[settlement_type]', default_value: @settlement_type_defaults[:value], default_text: @settlement_type_defaults[:text], dropdown_options: @settlement_type_dropdown
    .input-field-container-horizontal
      %span= t('common_table_headings.trade_date')
      = render 'shared/date_picker', single_date_picker: true, input_field_text: '{replace_date}', from_label: '', linked_input_field: 'securities_release_request[trade_date]', start_date: @securities_release_request.trade_date
    .input-field-container-horizontal
      %span= t('common_table_headings.settlement_date')
      = render 'shared/date_picker', single_date_picker: true, input_field_text: '{replace_date}', from_label: '', linked_input_field: 'securities_release_request[settlement_date]', start_date: @securities_release_request.settlement_date
  %section.securities-delivery-instructions
    %h2= t('securities.release.delivery_instructions.label')
    = render 'shared/dropdown', dropdown_name: 'securities_release_request[delivery_type]', default_value: @delivery_instructions_defaults[:value], default_text: @delivery_instructions_defaults[:text], dropdown_options: @delivery_instructions_dropdown
    .securities-delivery-instructions-fields{data: {'selected-delivery-instruction' => @delivery_instructions_defaults[:value]}}
      .securities-delivery-instructions-field.securities-delivery-instructions-field-physical-securities
        = render 'shared/input_field', form_builder: f, field_name: :receiving_bank_agent_name, label: t('securities.release.delivery_instructions.agent_name'), horizontal: true
        = render 'shared/input_field', form_builder: f, field_name: :receiving_bank_agent_address, label: t('securities.release.delivery_instructions.agent_address'), horizontal: true
        = render 'shared/input_field', form_builder: f, field_name: :physical_securities_credit_account_number, label: t('securities.release.delivery_instructions.further_credit'), horizontal: true
      .securities-delivery-instructions-field.securities-delivery-instructions-field-fed
        .securities-fed-wire-address-fields
          %p= t('securities.release.clearing_agent')
          = render 'shared/input_field', form_builder: f, field_name: :clearing_agent_fed_wire_address_1
          %span /
          = render 'shared/input_field', form_builder: f, field_name: :clearing_agent_fed_wire_address_2
        = render 'shared/input_field', form_builder: f, field_name: :aba_number, label: t('securities.release.delivery_instructions.aba'), horizontal: true
        = render 'shared/input_field', form_builder: f, field_name: :fed_credit_account_number, label: t('securities.release.delivery_instructions.further_credit'), horizontal: true
      .securities-delivery-instructions-field.securities-delivery-instructions-field-dtc
        = render 'shared/input_field', form_builder: f, field_name: :clearing_agent_participant_number, label: t('securities.release.delivery_instructions.participant_number'), horizontal: true
        = render 'shared/input_field', form_builder: f, field_name: :dtc_credit_account_number, label: t('securities.release.delivery_instructions.further_credit'), horizontal: true
      .securities-delivery-instructions-field.securities-delivery-instructions-field-mutual-fund
        = render 'shared/input_field', form_builder: f, field_name: :mutual_fund_company, label: t('securities.release.delivery_instructions.mutual_fund'), horizontal: true
        = render 'shared/input_field', form_builder: f, field_name: :mutual_fund_account_number, label: t('securities.release.delivery_instructions.account_number'), horizontal: true
  %section.securities-display
    -if type == :safekeep || type == :pledge
      %h2.safekeep-pledge-title= t('securities.title')
      .securities-download-template.safekeep-pledge-download-title{data: {'form-submit-trigger' => true, 'form-name' => 'securities-release-download'}}= t('securities.safekeep_pledge.upload_instructions.download_template')
    -else
      %h2= t('securities.title')
    %p.securities-release-upload-error= t('securities.release.edit.upload_error')
    -if @securities_release_request.securities
      .securities-release-table-wrapper
        = render 'upload_release'
      %p.securities-table-footnote= t('securities.release.settlement_amount_footnote', footnote_marker: fhlb_footnote_marker)
    -if type == :release
      = render partial: "release_help"
    -elsif type == :safekeep || type == :pledge
      = render partial: "safekeep_pledge_help"
  - if policy(:security).authorize?
    .securities-request-legal
      =simple_format(t('securities.release.legal_copy'))
  .securities-actions
    %span.secondary-button.delete-release-trigger= t('global.delete')
    = submit_tag(@form_data[:submit_text], class: 'primary-button')