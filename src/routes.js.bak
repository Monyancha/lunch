/**
 * React Starter Kit (https://www.reactstarterkit.com/)
 *
 * Copyright Â© 2014-2016 Kriasoft, LLC. All rights reserved.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.txt file in the root directory of this source tree.
 */

import React from 'react';
import { IndexRoute, Route } from 'react-router';
import AdminUsersPageContainer from './containers/admin/AdminUsersPageContainer';
import AppContainer from './containers/AppContainer';
import HomePageContainer from './containers/HomePageContainer';
import RestaurantsPageContainer from './containers/RestaurantsPageContainer';
import NotFoundPage from './components/NotFoundPage';

const makeRoutes = (store) => {
  const hasRole = (user, team, role) => {
    if (!role || user.superuser) {
      return true;
    }
    const teamRole = user.roles.find(userRole => userRole.team_id === userRole.id);
    if (!teamRole) {
      return false;
    }
    switch (role) {
      case 'admin':
        return teamRole.type === 'admin' || teamRole.type === 'owner';
      case 'owner':
        return teamRole.type === 'owner';
      default:
        return false;
    }
  };

  const requireAuth = role => (nextState, replace, callback) => {
    const state = store.getState();
    const user = state.user;
    const team = state.team;
    if (user.id && hasRole(user, team, role)) {
      callback();
    } else {
      replace(`/login?next=${nextState.location.pathname}${nextState.location.search}`);
      callback();
    }
  };

  return (
    <Route path="/" component={AppContainer}>
      <IndexRoute component={HomePageContainer} />
      <Route path="teams/:slug" onEnter={requireAuth()}>
        <IndexRoute component={RestaurantsPageContainer} />
      </Route>
      <Route path="admin" onEnter={requireAuth('admin')} component={AdminUsersPageContainer}>
        <IndexRoute component={AdminUsersPageContainer} />
      </Route>
      <Route path="*" component={NotFoundPage} />
    </Route>
  );
};

export default makeRoutes;
